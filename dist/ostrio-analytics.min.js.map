{"version":3,"file":"ostrio-analytics.min.js","sources":["../src/index.ts"],"sourcesContent":["export enum Transport {\n  Fetch = 'fetch',\n  Beacon = 'beacon',\n  Img = 'img'\n}\n\nexport const SUPPORTED_TRANSPORTS = [Transport.Fetch, Transport.Beacon, Transport.Img] as const;\n\nconst DEFAULTS = {\n  serviceUrl: 'https://analytics.ostr.io/',\n  version: 300,\n  pollMs: 500,\n  trackDelayMs: 64,\n  globalError: {\n    msg: 'N/A',\n    url: '',\n    line: '0',\n    column: '0'\n  },\n  fetchConf: {\n    credentials: 'include',\n    mode: 'no-cors',\n    cache: 'no-store',\n  }\n} as const;\n\nenum EventName {\n  GlobalError = '[Global Error]',\n  HashChange = 'hashchange',\n  PopState = 'popstate',\n  UnhandledRejection = 'unhandledrejection'\n}\n\nconst QUERY = {\n  href: '6',\n  title: '2',\n  referrer: '1',\n  event: '3',\n  noise: '9',\n  version: 'v',\n  timestamp: '11'\n} as const;\n\nconst LIMITS = {\n  href: 1024,\n  referrer: 1024,\n  title: 512,\n  eventKey: 24,\n  eventValue: 64,\n  errorValue: 512\n} as const;\n\nconst WARN = {\n  sidError: '[init] {{trackingId}} is missing or incorrect!',\n  pushEventMissing: '[pushEvent] Can\\'t add event without key or value!',\n  fetchError: '[track] [fetch] Error:'\n} as const;\n\nexport interface OstrioWebAnalyticsDynamincConfig {\n  trackHash?: boolean;\n  trackQuery?: boolean;\n  transport?: Transport;\n  serviceUrl?: string;\n}\n\nexport interface OstrioWebAnalyticsConfig extends OstrioWebAnalyticsDynamincConfig {\n  auto?: boolean;\n  trackErrors?: boolean;\n  ignoredQueries?: Array<string>;\n  ignoredPaths?: Array<string | RegExp>;\n}\n\ntype EvtRemvr = () => void;\ntype FetchCb = () => void;\ntype TrackCb = () => void;\ntype EventCb = (key: string, value: number|string) => void;\n\nexport class OstrioWebAnalytics {\n  public readonly sid: string;\n  public readonly version: number = DEFAULTS.version;\n  public sending: boolean = false;\n  public readonly loc: Location = globalThis.location;\n  public current: string = '';\n  public trackHash: boolean = true;\n  public trackQuery: boolean = true;\n  public readonly ignoredQueries: Set<string> = new Set();\n  public readonly auto: boolean;\n  public readonly trackErrors: boolean;\n  public transport: Transport = Transport.Fetch;\n  public serviceUrl: string = DEFAULTS.serviceUrl;\n  private readonly ignoredPaths: Set<string | RegExp> = new Set();\n  private readonly onTrackArr: TrackCb[] = [];\n  private readonly onEventArr: EventCb[] = [];\n  private readonly cachedErrors: Set<string> = new Set();\n  private readonly warn: (...args: unknown[]) => void;\n  private readonly eventRemovers: EvtRemvr[] = [];\n  private autoTimer: ReturnType<typeof setInterval> | null = null;\n  private lastTrackTimestamp: number | false = false;\n\n  constructor(sid: string, opts?: OstrioWebAnalyticsConfig | boolean) {\n    const cfg: OstrioWebAnalyticsConfig = typeof opts === 'boolean' ? { auto: opts } : (opts || {});\n    this.sid = sid;\n    this.auto = !(cfg.auto === false);\n    this.trackErrors = !(cfg.trackErrors === false);\n    cfg.ignoredQueries && this.ignoreQueries(cfg.ignoredQueries);\n    cfg.ignoredPaths && this.ignorePaths(cfg.ignoredPaths);\n\n    this.applySettings(cfg);\n\n    this.warn = function () {\n      if (typeof console === 'undefined') return;\n      const fn = typeof console.warn === 'function' ? console.warn : typeof console.log === 'function' ? console.log : null;\n      if (!fn) return;\n      const args = Array.from(arguments);\n      args.unshift('[ostrio]');\n      fn.apply(console, args);\n    };\n\n    if (!this.sid || typeof this.sid !== 'string' || this.sid.length !== 17) {\n      this.warn(WARN.sidError);\n      return;\n    }\n\n    if (this.auto) {\n      this.initAutoTracking();\n    }\n\n    if (this.trackErrors) {\n      this.initGlobalErrors();\n    }\n  }\n\n  private on(obj: Window | Document | HTMLElement | EventTarget, type: string, fn: EventListenerOrEventListenerObject): void {\n    obj.addEventListener(type, fn, false);\n    this.eventRemovers.push(() => {\n      obj.removeEventListener(type, fn, false);\n    });\n  }\n\n\n  public applySettings(cfg: OstrioWebAnalyticsDynamincConfig) {\n    if (typeof cfg.trackHash !== 'undefined') {\n      this.trackHash = !(cfg.trackHash === false);\n    }\n\n    if (typeof cfg.trackQuery !== 'undefined') {\n      this.trackQuery = !(cfg.trackQuery === false);\n    }\n\n    if (cfg.serviceUrl && typeof cfg.serviceUrl === 'string' && cfg.serviceUrl.length) {\n      this.serviceUrl = cfg.serviceUrl;\n      this.serviceUrl = this.serviceUrl.endsWith('/') ? this.serviceUrl : `${this.serviceUrl}/`;\n    }\n\n    if (cfg.transport) {\n      this.setTransport(cfg.transport);\n    }\n  }\n\n  public setTransport(t: Transport): void {\n    if (SUPPORTED_TRANSPORTS.includes(t)) {\n      this.transport = t;\n    }\n  }\n\n  public ignorePath(path: string | RegExp): void {\n    this.ignoredPaths.add(path);\n  }\n\n  public ignorePaths(paths: Array<string | RegExp>): void {\n    if (Array.isArray(paths)) {\n      paths.forEach(this.ignorePath.bind(this));\n    }\n  }\n\n  public ignoreQuery(queryKey: string): void {\n    this.ignoredQueries.add(queryKey.toLowerCase());\n  }\n\n  public ignoreQueries(queryKeys: Array<string>): void {\n    if (Array.isArray(queryKeys)) {\n      queryKeys.forEach(this.ignoreQuery.bind(this));\n    }\n  }\n\n  public onPushEvent(callback: EventCb): void {\n    if (typeof callback === 'function') {\n      this.onEventArr.push(callback);\n    }\n  }\n\n  public onTrack(callback: TrackCb): void {\n    if (typeof callback === 'function') {\n      this.onTrackArr.push(callback);\n    }\n  }\n\n  public pushEvent(rawKey: string, rawValue: number|string): void {\n    let key = String(rawKey).trim();\n    let value = String(rawValue).trim();\n\n    if (!key || !value) {\n      this.warn(WARN.pushEventMissing);\n      return;\n    }\n\n    for (let i = this.onEventArr.length - 1; i >= 0; i--) {\n      this.onEventArr[i]?.(rawKey, rawValue);\n    }\n\n    const event: Record<string, string> = {};\n\n    if (key === EventName.GlobalError) {\n      value = value.trim().slice(0, LIMITS.errorValue);\n      if (this.cachedErrors.has(value)) {\n        return;\n      }\n      this.cachedErrors.add(value);\n    } else {\n      value = value.trim().slice(0, LIMITS.eventValue);\n    }\n\n    key = key.trim().slice(0, LIMITS.eventKey);\n    event[key] = value;\n\n    const query = new URLSearchParams();\n    query.set(QUERY.event, JSON.stringify(event));\n    this.send(query);\n  }\n\n  public track(): boolean {\n    if (this.isIgnored(this.loc.pathname)) {\n      return false;\n    }\n\n    for (let i = this.onTrackArr.length - 1; i >= 0; i--) {\n      this.onTrackArr[i]?.();\n    }\n\n    return this.send(new URLSearchParams());\n  }\n\n  private send(query: URLSearchParams): boolean {\n    query.set(QUERY.noise, String(Date.now()).slice(-7));\n    query.set(QUERY.version, String(this.version));\n\n    if (query.has(QUERY.event)) {\n      this.fetch(query, (): void => {});\n      return true;\n    }\n\n    if ((!this.sending && this.current !== this.getCurrentUrl())) {\n      this.sending = true;\n\n      setTimeout((): void => {\n        this.current = this.getCurrentUrl();\n        if (this.lastTrackTimestamp) {\n          query.set(QUERY.timestamp, String(this.lastTrackTimestamp));\n        }\n\n        this.lastTrackTimestamp = Date.now();\n        query.set(QUERY.href, this.current.slice(0, LIMITS.href));\n        query.set(QUERY.title, document.title.trim().slice(0, LIMITS.title));\n\n        if (document.referrer && document.referrer.indexOf(this.loc.origin) === -1) {\n          query.set(QUERY.referrer, document.referrer.trim().slice(0, LIMITS.referrer));\n        }\n\n        this.fetch(query, (): void => {\n          this.sending = false;\n        });\n      }, DEFAULTS.trackDelayMs);\n\n      return true;\n    }\n\n    return false;\n  }\n\n  private fetch(query: URLSearchParams, cb: FetchCb): void {\n    const url = `${this.serviceUrl}${this.sid}.gif?${query.toString()}`;\n\n    if (this.transport === Transport.Beacon && 'sendBeacon' in navigator) {\n      navigator.sendBeacon(url);\n      cb();\n      return;\n    }\n\n    if (this.transport === Transport.Img) {\n      let imageLoader: HTMLImageElement | null = 'Image' in window ? new Image() : (document.createElement('img') as HTMLImageElement);\n      imageLoader.onload = (): void => { imageLoader = null; };\n      imageLoader.src = url;\n      cb();\n      return;\n    }\n\n    fetch(url, DEFAULTS.fetchConf).then(cb).catch((err) => {\n      this.warn(WARN.fetchError, err);\n      cb();\n    });\n  }\n\n  private initAutoTracking(): void {\n    const autoTrack = (): void => {\n      this.track();\n    };\n\n    if (this.trackHash) {\n      this.on(window, EventName.HashChange, autoTrack);\n    }\n\n    this.on(window, EventName.PopState, autoTrack);\n\n    this.autoTimer = setInterval((): void => {\n      if (!this.sending && this.current !== this.getCurrentUrl()) {\n        autoTrack();\n      }\n    }, DEFAULTS.pollMs);\n\n    autoTrack();\n  }\n\n  private initGlobalErrors(): void {\n    const prev = window.onerror as OnErrorEventHandlerNonNull | null;\n    window.onerror = ((msg: Event|string, url: string, line: number, column: number, error: Error): void => {\n      const m = String(msg || DEFAULTS.globalError.msg);\n      const u = String(url || DEFAULTS.globalError.url);\n      const ln = String(line || DEFAULTS.globalError.line);\n      const col = String(column || DEFAULTS.globalError.column);\n\n      if (u.includes(this.loc.origin)) {\n        this.pushEvent(EventName.GlobalError, `Error: ${m}. File: ${u.replace(this.loc.origin, '')} at ${this.loc.href}:${ln}:${col}`);\n      }\n\n      if (typeof prev === 'function') {\n        prev.call(window, msg, url, line, column, error);\n      }\n    }) as OnErrorEventHandlerNonNull;\n\n    this.on(window, EventName.UnhandledRejection, (evt: Event): void => {\n      const e = evt as PromiseRejectionEvent;\n      const v = (e && typeof e.reason === 'object' && e.reason && 'message' in e.reason) ? String(e.reason.message) : String(e?.reason ?? 'Undefined Rejection Reason');\n      this.pushEvent(EventName.GlobalError, `Unhandled Rejection: ${v}. At: ${this.loc.href}`);\n    });\n  }\n\n  private isIgnored(pathname: string): boolean {\n    if (!this.ignoredPaths.size) {\n      return false;\n    }\n\n    const paths = Array.from(this.ignoredPaths);\n    for (let i = paths.length - 1; i >= 0; i--) {\n      const rule = paths[i];\n      if (typeof rule === 'string') {\n        if (rule.endsWith('*')) {\n          const prefix = rule.slice(0, -1);\n          if (pathname.startsWith(prefix)) {\n            return true;\n          }\n        } else {\n          if (pathname === rule) {\n            return true;\n          }\n        }\n      } else if (rule instanceof RegExp) {\n        if (rule.test(pathname)) {\n          return true;\n        }\n      }\n    }\n    return false;\n  }\n\n  private getCurrentUrl() {\n    const url = new URL(this.loc.href);\n    if (!this.trackHash) {\n      url.hash = '';\n    }\n\n    if (!this.trackQuery) {\n      url.search = '';\n    } else if (this.ignoredQueries.size) {\n      Array.from(url.searchParams.keys()).forEach((key: string) => {\n        if (this.ignoredQueries.has(key.toLowerCase())) {\n          url.searchParams.delete(key);\n        }\n      });\n    }\n\n    return url.href;\n  }\n\n  public destroy(): void {\n    for (let i = this.eventRemovers.length - 1; i >= 0; i--) {\n      this.eventRemovers[i]?.();\n    }\n    this.eventRemovers.length = 0;\n    if (this.autoTimer) {\n      clearInterval(this.autoTimer);\n      this.autoTimer = null;\n    }\n  }\n}\n\nexport default OstrioWebAnalytics;\n"],"names":["Transport","EventName","SUPPORTED_TRANSPORTS","Fetch","Beacon","Img","DEFAULTS","msg","url","line","column","credentials","mode","cache","QUERY","LIMITS","WARN","OstrioWebAnalytics","sid","opts","this","version","sending","loc","globalThis","location","current","trackHash","trackQuery","ignoredQueries","Set","transport","serviceUrl","ignoredPaths","onTrackArr","onEventArr","cachedErrors","eventRemovers","autoTimer","lastTrackTimestamp","cfg","auto","trackErrors","ignoreQueries","ignorePaths","applySettings","warn","console","fn","log","args","Array","from","arguments","unshift","apply","length","initAutoTracking","initGlobalErrors","prototype","on","obj","type","addEventListener","push","removeEventListener","endsWith","concat","setTransport","t","includes","ignorePath","path","add","paths","isArray","forEach","bind","ignoreQuery","queryKey","toLowerCase","queryKeys","onPushEvent","callback","onTrack","pushEvent","rawKey","rawValue","key","String","trim","value","i","_b","_a","call","event","GlobalError","slice","has","query","URLSearchParams","set","JSON","stringify","send","track","isIgnored","pathname","_this","Date","now","fetch","getCurrentUrl","setTimeout","document","title","referrer","indexOf","origin","cb","toString","navigator","sendBeacon","imageLoader_1","window","Image","createElement","onload","src","then","catch","err","autoTrack","HashChange","PopState","setInterval","prev","onerror","error","m","u","ln","col","replace","href","UnhandledRejection","evt","e","v","reason","message","size","rule","prefix","startsWith","RegExp","test","URL","hash","searchParams","keys","delete","search","destroy","clearInterval"],"mappings":"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"}