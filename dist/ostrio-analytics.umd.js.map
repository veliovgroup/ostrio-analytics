{"version":3,"file":"ostrio-analytics.umd.js","sources":["../src/index.ts"],"sourcesContent":["export enum Transport {\n  Fetch = 'fetch',\n  Beacon = 'beacon',\n  Img = 'img'\n}\n\nexport const SUPPORTED_TRANSPORTS = [Transport.Fetch, Transport.Beacon, Transport.Img] as const;\n\nconst DEFAULTS = {\n  serviceUrl: 'https://analytics.ostr.io/',\n  version: 300,\n  pollMs: 500,\n  trackDelayMs: 64,\n  globalError: {\n    msg: 'N/A',\n    url: '',\n    line: '0',\n    column: '0'\n  },\n  fetchConf: {\n    credentials: 'include',\n    mode: 'no-cors',\n    cache: 'no-store',\n  }\n} as const;\n\nenum EventName {\n  GlobalError = '[Global Error]',\n  HashChange = 'hashchange',\n  PopState = 'popstate',\n  UnhandledRejection = 'unhandledrejection'\n}\n\nconst QUERY = {\n  href: '6',\n  title: '2',\n  referrer: '1',\n  event: '3',\n  noise: '9',\n  version: 'v',\n  timestamp: '11'\n} as const;\n\nconst LIMITS = {\n  href: 1024,\n  referrer: 1024,\n  title: 512,\n  eventKey: 24,\n  eventValue: 64,\n  errorValue: 512\n} as const;\n\nconst WARN = {\n  sidError: '[init] {{trackingId}} is missing or incorrect!',\n  pushEventMissing: '[pushEvent] Can\\'t add event without key or value!',\n  fetchError: '[track] [fetch] Error:'\n} as const;\n\nexport interface OstrioWebAnalyticsDynamincConfig {\n  trackHash?: boolean;\n  trackQuery?: boolean;\n  transport?: Transport;\n  serviceUrl?: string;\n}\n\nexport interface OstrioWebAnalyticsConfig extends OstrioWebAnalyticsDynamincConfig {\n  auto?: boolean;\n  trackErrors?: boolean;\n  ignoredQueries?: Array<string>;\n  ignoredPaths?: Array<string | RegExp>;\n}\n\ntype EvtRemvr = () => void;\ntype FetchCb = () => void;\ntype TrackCb = () => void;\ntype EventCb = (key: string, value: number|string) => void;\n\nexport class OstrioWebAnalytics {\n  public readonly sid: string;\n  public readonly version: number = DEFAULTS.version;\n  public sending: boolean = false;\n  public readonly loc: Location = globalThis.location;\n  public current: string = '';\n  public trackHash: boolean = true;\n  public trackQuery: boolean = true;\n  public readonly ignoredQueries: Set<string> = new Set();\n  public readonly auto: boolean;\n  public readonly trackErrors: boolean;\n  public transport: Transport = Transport.Fetch;\n  public serviceUrl: string = DEFAULTS.serviceUrl;\n  private readonly ignoredPaths: Set<string | RegExp> = new Set();\n  private readonly onTrackArr: TrackCb[] = [];\n  private readonly onEventArr: EventCb[] = [];\n  private readonly cachedErrors: Set<string> = new Set();\n  private readonly warn: (...args: unknown[]) => void;\n  private readonly eventRemovers: EvtRemvr[] = [];\n  private autoTimer: ReturnType<typeof setInterval> | null = null;\n  private lastTrackTimestamp: number | false = false;\n\n  constructor(sid: string, opts?: OstrioWebAnalyticsConfig | boolean) {\n    const cfg: OstrioWebAnalyticsConfig = typeof opts === 'boolean' ? { auto: opts } : (opts || {});\n    this.sid = sid;\n    this.auto = !(cfg.auto === false);\n    this.trackErrors = !(cfg.trackErrors === false);\n    cfg.ignoredQueries && this.ignoreQueries(cfg.ignoredQueries);\n    cfg.ignoredPaths && this.ignorePaths(cfg.ignoredPaths);\n\n    this.applySettings(cfg);\n\n    this.warn = function () {\n      if (typeof console === 'undefined') return;\n      const fn = typeof console.warn === 'function' ? console.warn : typeof console.log === 'function' ? console.log : null;\n      if (!fn) return;\n      const args = Array.from(arguments);\n      args.unshift('[ostrio]');\n      fn.apply(console, args);\n    };\n\n    if (!this.sid || typeof this.sid !== 'string' || this.sid.length !== 17) {\n      this.warn(WARN.sidError);\n      return;\n    }\n\n    if (this.auto) {\n      this.initAutoTracking();\n    }\n\n    if (this.trackErrors) {\n      this.initGlobalErrors();\n    }\n  }\n\n  private on(obj: Window | Document | HTMLElement | EventTarget, type: string, fn: EventListenerOrEventListenerObject): void {\n    obj.addEventListener(type, fn, false);\n    this.eventRemovers.push(() => {\n      obj.removeEventListener(type, fn, false);\n    });\n  }\n\n\n  public applySettings(cfg: OstrioWebAnalyticsDynamincConfig) {\n    if (typeof cfg.trackHash !== 'undefined') {\n      this.trackHash = !(cfg.trackHash === false);\n    }\n\n    if (typeof cfg.trackQuery !== 'undefined') {\n      this.trackQuery = !(cfg.trackQuery === false);\n    }\n\n    if (cfg.serviceUrl && typeof cfg.serviceUrl === 'string' && cfg.serviceUrl.length) {\n      this.serviceUrl = cfg.serviceUrl;\n      this.serviceUrl = this.serviceUrl.endsWith('/') ? this.serviceUrl : `${this.serviceUrl}/`;\n    }\n\n    if (cfg.transport) {\n      this.setTransport(cfg.transport);\n    }\n  }\n\n  public setTransport(t: Transport): void {\n    if (SUPPORTED_TRANSPORTS.includes(t)) {\n      this.transport = t;\n    }\n  }\n\n  public ignorePath(path: string | RegExp): void {\n    this.ignoredPaths.add(path);\n  }\n\n  public ignorePaths(paths: Array<string | RegExp>): void {\n    if (Array.isArray(paths)) {\n      paths.forEach(this.ignorePath.bind(this));\n    }\n  }\n\n  public ignoreQuery(queryKey: string): void {\n    this.ignoredQueries.add(queryKey.toLowerCase());\n  }\n\n  public ignoreQueries(queryKeys: Array<string>): void {\n    if (Array.isArray(queryKeys)) {\n      queryKeys.forEach(this.ignoreQuery.bind(this));\n    }\n  }\n\n  public onPushEvent(callback: EventCb): void {\n    if (typeof callback === 'function') {\n      this.onEventArr.push(callback);\n    }\n  }\n\n  public onTrack(callback: TrackCb): void {\n    if (typeof callback === 'function') {\n      this.onTrackArr.push(callback);\n    }\n  }\n\n  public pushEvent(rawKey: string, rawValue: number|string): void {\n    let key = String(rawKey).trim();\n    let value = String(rawValue).trim();\n\n    if (!key || !value) {\n      this.warn(WARN.pushEventMissing);\n      return;\n    }\n\n    for (let i = this.onEventArr.length - 1; i >= 0; i--) {\n      this.onEventArr[i]?.(rawKey, rawValue);\n    }\n\n    const event: Record<string, string> = {};\n\n    if (key === EventName.GlobalError) {\n      value = value.trim().slice(0, LIMITS.errorValue);\n      if (this.cachedErrors.has(value)) {\n        return;\n      }\n      this.cachedErrors.add(value);\n    } else {\n      value = value.trim().slice(0, LIMITS.eventValue);\n    }\n\n    key = key.trim().slice(0, LIMITS.eventKey);\n    event[key] = value;\n\n    const query = new URLSearchParams();\n    query.set(QUERY.event, JSON.stringify(event));\n    this.send(query);\n  }\n\n  public track(): boolean {\n    if (this.isIgnored(this.loc.pathname)) {\n      return false;\n    }\n\n    for (let i = this.onTrackArr.length - 1; i >= 0; i--) {\n      this.onTrackArr[i]?.();\n    }\n\n    return this.send(new URLSearchParams());\n  }\n\n  private send(query: URLSearchParams): boolean {\n    query.set(QUERY.noise, String(Date.now()).slice(-7));\n    query.set(QUERY.version, String(this.version));\n\n    if (query.has(QUERY.event)) {\n      this.fetch(query, (): void => {});\n      return true;\n    }\n\n    if ((!this.sending && this.current !== this.getCurrentUrl())) {\n      this.sending = true;\n\n      setTimeout((): void => {\n        this.current = this.getCurrentUrl();\n        if (this.lastTrackTimestamp) {\n          query.set(QUERY.timestamp, String(this.lastTrackTimestamp));\n        }\n\n        this.lastTrackTimestamp = Date.now();\n        query.set(QUERY.href, this.current.slice(0, LIMITS.href));\n        query.set(QUERY.title, document.title.trim().slice(0, LIMITS.title));\n\n        if (document.referrer && document.referrer.indexOf(this.loc.origin) === -1) {\n          query.set(QUERY.referrer, document.referrer.trim().slice(0, LIMITS.referrer));\n        }\n\n        this.fetch(query, (): void => {\n          this.sending = false;\n        });\n      }, DEFAULTS.trackDelayMs);\n\n      return true;\n    }\n\n    return false;\n  }\n\n  private fetch(query: URLSearchParams, cb: FetchCb): void {\n    const url = `${this.serviceUrl}${this.sid}.gif?${query.toString()}`;\n\n    if (this.transport === Transport.Beacon && 'sendBeacon' in navigator) {\n      navigator.sendBeacon(url);\n      cb();\n      return;\n    }\n\n    if (this.transport === Transport.Img) {\n      let imageLoader: HTMLImageElement | null = 'Image' in window ? new Image() : (document.createElement('img') as HTMLImageElement);\n      imageLoader.onload = (): void => { imageLoader = null; };\n      imageLoader.src = url;\n      cb();\n      return;\n    }\n\n    fetch(url, DEFAULTS.fetchConf).then(cb).catch((err) => {\n      this.warn(WARN.fetchError, err);\n      cb();\n    });\n  }\n\n  private initAutoTracking(): void {\n    const autoTrack = (): void => {\n      this.track();\n    };\n\n    if (this.trackHash) {\n      this.on(window, EventName.HashChange, autoTrack);\n    }\n\n    this.on(window, EventName.PopState, autoTrack);\n\n    this.autoTimer = setInterval((): void => {\n      if (!this.sending && this.current !== this.getCurrentUrl()) {\n        autoTrack();\n      }\n    }, DEFAULTS.pollMs);\n\n    autoTrack();\n  }\n\n  private initGlobalErrors(): void {\n    const prev = window.onerror as OnErrorEventHandlerNonNull | null;\n    window.onerror = ((msg: Event|string, url: string, line: number, column: number, error: Error): void => {\n      const m = String(msg || DEFAULTS.globalError.msg);\n      const u = String(url || DEFAULTS.globalError.url);\n      const ln = String(line || DEFAULTS.globalError.line);\n      const col = String(column || DEFAULTS.globalError.column);\n\n      if (u.includes(this.loc.origin)) {\n        this.pushEvent(EventName.GlobalError, `Error: ${m}. File: ${u.replace(this.loc.origin, '')} at ${this.loc.href}:${ln}:${col}`);\n      }\n\n      if (typeof prev === 'function') {\n        prev.call(window, msg, url, line, column, error);\n      }\n    }) as OnErrorEventHandlerNonNull;\n\n    this.on(window, EventName.UnhandledRejection, (evt: Event): void => {\n      const e = evt as PromiseRejectionEvent;\n      const v = (e && typeof e.reason === 'object' && e.reason && 'message' in e.reason) ? String(e.reason.message) : String(e?.reason ?? 'Undefined Rejection Reason');\n      this.pushEvent(EventName.GlobalError, `Unhandled Rejection: ${v}. At: ${this.loc.href}`);\n    });\n  }\n\n  private isIgnored(pathname: string): boolean {\n    if (!this.ignoredPaths.size) {\n      return false;\n    }\n\n    const paths = Array.from(this.ignoredPaths);\n    for (let i = paths.length - 1; i >= 0; i--) {\n      const rule = paths[i];\n      if (typeof rule === 'string') {\n        if (rule.endsWith('*')) {\n          const prefix = rule.slice(0, -1);\n          if (pathname.startsWith(prefix)) {\n            return true;\n          }\n        } else {\n          if (pathname === rule) {\n            return true;\n          }\n        }\n      } else if (rule instanceof RegExp) {\n        if (rule.test(pathname)) {\n          return true;\n        }\n      }\n    }\n    return false;\n  }\n\n  private getCurrentUrl() {\n    const url = new URL(this.loc.href);\n    if (!this.trackHash) {\n      url.hash = '';\n    }\n\n    if (!this.trackQuery) {\n      url.search = '';\n    } else if (this.ignoredQueries.size) {\n      Array.from(url.searchParams.keys()).forEach((key: string) => {\n        if (this.ignoredQueries.has(key.toLowerCase())) {\n          url.searchParams.delete(key);\n        }\n      });\n    }\n\n    return url.href;\n  }\n\n  public destroy(): void {\n    for (let i = this.eventRemovers.length - 1; i >= 0; i--) {\n      this.eventRemovers[i]?.();\n    }\n    this.eventRemovers.length = 0;\n    if (this.autoTimer) {\n      clearInterval(this.autoTimer);\n      this.autoTimer = null;\n    }\n  }\n}\n\nexport default OstrioWebAnalytics;\n"],"names":[],"mappings":"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"}