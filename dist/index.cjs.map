{"version":3,"file":"index.cjs","sources":["../src/index.ts"],"sourcesContent":["export enum Transport {\n  Fetch = 'fetch',\n  Beacon = 'beacon',\n  Img = 'img'\n}\n\nexport const SUPPORTED_TRANSPORTS = [Transport.Fetch, Transport.Beacon, Transport.Img] as const;\n\nconst DEFAULTS = {\n  serviceUrl: 'https://analytics.ostr.io/',\n  version: 300,\n  pollMs: 500,\n  trackDelayMs: 64,\n  globalError: {\n    msg: 'N/A',\n    url: '',\n    line: '0',\n    column: '0'\n  },\n  fetchConf: {\n    credentials: 'include',\n    mode: 'no-cors',\n    cache: 'no-store',\n  }\n} as const;\n\nenum EventName {\n  GlobalError = '[Global Error]',\n  HashChange = 'hashchange',\n  PopState = 'popstate',\n  UnhandledRejection = 'unhandledrejection'\n}\n\nconst QUERY = {\n  href: '6',\n  title: '2',\n  referrer: '1',\n  event: '3',\n  noise: '9',\n  version: 'v',\n  timestamp: '11'\n} as const;\n\nconst LIMITS = {\n  href: 1024,\n  referrer: 1024,\n  title: 512,\n  eventKey: 24,\n  eventValue: 64,\n  errorValue: 512\n} as const;\n\nconst WARN = {\n  sidError: '[init] {{trackingId}} is missing or incorrect!',\n  pushEventMissing: '[pushEvent] Can\\'t add event without key or value!',\n  fetchError: '[track] [fetch] Error:'\n} as const;\n\nexport interface OstrioWebAnalyticsDynamincConfig {\n  trackHash?: boolean;\n  trackQuery?: boolean;\n  transport?: Transport;\n  serviceUrl?: string;\n}\n\nexport interface OstrioWebAnalyticsConfig extends OstrioWebAnalyticsDynamincConfig {\n  auto?: boolean;\n  trackErrors?: boolean;\n  ignoredQueries?: Array<string>;\n  ignoredPaths?: Array<string | RegExp>;\n}\n\ntype EvtRemvr = () => void;\ntype FetchCb = () => void;\ntype TrackCb = () => void;\ntype EventCb = (key: string, value: number|string) => void;\n\nexport class OstrioWebAnalytics {\n  public readonly sid: string;\n  public readonly version: number = DEFAULTS.version;\n  public sending: boolean = false;\n  public readonly loc: Location = globalThis.location;\n  public current: string = '';\n  public trackHash: boolean = true;\n  public trackQuery: boolean = true;\n  public readonly ignoredQueries: Set<string> = new Set();\n  public readonly auto: boolean;\n  public readonly trackErrors: boolean;\n  public transport: Transport = Transport.Fetch;\n  public serviceUrl: string = DEFAULTS.serviceUrl;\n  private readonly ignoredPaths: Set<string | RegExp> = new Set();\n  private readonly onTrackArr: TrackCb[] = [];\n  private readonly onEventArr: EventCb[] = [];\n  private readonly cachedErrors: Set<string> = new Set();\n  private readonly warn: (...args: unknown[]) => void;\n  private readonly eventRemovers: EvtRemvr[] = [];\n  private autoTimer: ReturnType<typeof setInterval> | null = null;\n  private lastTrackTimestamp: number | false = false;\n\n  constructor(sid: string, opts?: OstrioWebAnalyticsConfig | boolean) {\n    const cfg: OstrioWebAnalyticsConfig = typeof opts === 'boolean' ? { auto: opts } : (opts || {});\n    this.sid = sid;\n    this.auto = !(cfg.auto === false);\n    this.trackErrors = !(cfg.trackErrors === false);\n    cfg.ignoredQueries && this.ignoreQueries(cfg.ignoredQueries);\n    cfg.ignoredPaths && this.ignorePaths(cfg.ignoredPaths);\n\n    this.applySettings(cfg);\n\n    this.warn = function () {\n      if (typeof console === 'undefined') return;\n      const fn = typeof console.warn === 'function' ? console.warn : typeof console.log === 'function' ? console.log : null;\n      if (!fn) return;\n      const args = Array.from(arguments);\n      args.unshift('[ostrio]');\n      fn.apply(console, args);\n    };\n\n    if (!this.sid || typeof this.sid !== 'string' || this.sid.length !== 17) {\n      this.warn(WARN.sidError);\n      return;\n    }\n\n    if (this.auto) {\n      this.initAutoTracking();\n    }\n\n    if (this.trackErrors) {\n      this.initGlobalErrors();\n    }\n  }\n\n  private on(obj: Window | Document | HTMLElement | EventTarget, type: string, fn: EventListenerOrEventListenerObject): void {\n    obj.addEventListener(type, fn, false);\n    this.eventRemovers.push(() => {\n      obj.removeEventListener(type, fn, false);\n    });\n  }\n\n\n  public applySettings(cfg: OstrioWebAnalyticsDynamincConfig) {\n    if (typeof cfg.trackHash !== 'undefined') {\n      this.trackHash = !(cfg.trackHash === false);\n    }\n\n    if (typeof cfg.trackQuery !== 'undefined') {\n      this.trackQuery = !(cfg.trackQuery === false);\n    }\n\n    if (cfg.serviceUrl && typeof cfg.serviceUrl === 'string' && cfg.serviceUrl.length) {\n      this.serviceUrl = cfg.serviceUrl;\n      this.serviceUrl = this.serviceUrl.endsWith('/') ? this.serviceUrl : `${this.serviceUrl}/`;\n    }\n\n    if (cfg.transport) {\n      this.setTransport(cfg.transport);\n    }\n  }\n\n  public setTransport(t: Transport): void {\n    if (SUPPORTED_TRANSPORTS.includes(t)) {\n      this.transport = t;\n    }\n  }\n\n  public ignorePath(path: string | RegExp): void {\n    this.ignoredPaths.add(path);\n  }\n\n  public ignorePaths(paths: Array<string | RegExp>): void {\n    if (Array.isArray(paths)) {\n      paths.forEach(this.ignorePath.bind(this));\n    }\n  }\n\n  public ignoreQuery(queryKey: string): void {\n    this.ignoredQueries.add(queryKey.toLowerCase());\n  }\n\n  public ignoreQueries(queryKeys: Array<string>): void {\n    if (Array.isArray(queryKeys)) {\n      queryKeys.forEach(this.ignoreQuery.bind(this));\n    }\n  }\n\n  public onPushEvent(callback: EventCb): void {\n    if (typeof callback === 'function') {\n      this.onEventArr.push(callback);\n    }\n  }\n\n  public onTrack(callback: TrackCb): void {\n    if (typeof callback === 'function') {\n      this.onTrackArr.push(callback);\n    }\n  }\n\n  public pushEvent(rawKey: string, rawValue: number|string): void {\n    let key = String(rawKey).trim();\n    let value = String(rawValue).trim();\n\n    if (!key || !value) {\n      this.warn(WARN.pushEventMissing);\n      return;\n    }\n\n    for (let i = this.onEventArr.length - 1; i >= 0; i--) {\n      this.onEventArr[i]?.(rawKey, rawValue);\n    }\n\n    const event: Record<string, string> = {};\n\n    if (key === EventName.GlobalError) {\n      value = value.trim().slice(0, LIMITS.errorValue);\n      if (this.cachedErrors.has(value)) {\n        return;\n      }\n      this.cachedErrors.add(value);\n    } else {\n      value = value.trim().slice(0, LIMITS.eventValue);\n    }\n\n    key = key.trim().slice(0, LIMITS.eventKey);\n    event[key] = value;\n\n    const query = new URLSearchParams();\n    query.set(QUERY.event, JSON.stringify(event));\n    this.send(query);\n  }\n\n  public track(): boolean {\n    if (this.isIgnored(this.loc.pathname)) {\n      return false;\n    }\n\n    for (let i = this.onTrackArr.length - 1; i >= 0; i--) {\n      this.onTrackArr[i]?.();\n    }\n\n    return this.send(new URLSearchParams());\n  }\n\n  private send(query: URLSearchParams): boolean {\n    query.set(QUERY.noise, String(Date.now()).slice(-7));\n    query.set(QUERY.version, String(this.version));\n\n    if (query.has(QUERY.event)) {\n      this.fetch(query, (): void => {});\n      return true;\n    }\n\n    if ((!this.sending && this.current !== this.getCurrentUrl())) {\n      this.sending = true;\n\n      setTimeout((): void => {\n        this.current = this.getCurrentUrl();\n        if (this.lastTrackTimestamp) {\n          query.set(QUERY.timestamp, String(this.lastTrackTimestamp));\n        }\n\n        this.lastTrackTimestamp = Date.now();\n        query.set(QUERY.href, this.current.slice(0, LIMITS.href));\n        query.set(QUERY.title, document.title.trim().slice(0, LIMITS.title));\n\n        if (document.referrer && document.referrer.indexOf(this.loc.origin) === -1) {\n          query.set(QUERY.referrer, document.referrer.trim().slice(0, LIMITS.referrer));\n        }\n\n        this.fetch(query, (): void => {\n          this.sending = false;\n        });\n      }, DEFAULTS.trackDelayMs);\n\n      return true;\n    }\n\n    return false;\n  }\n\n  private fetch(query: URLSearchParams, cb: FetchCb): void {\n    const url = `${this.serviceUrl}${this.sid}.gif?${query.toString()}`;\n\n    if (this.transport === Transport.Beacon && 'sendBeacon' in navigator) {\n      navigator.sendBeacon(url);\n      cb();\n      return;\n    }\n\n    if (this.transport === Transport.Img) {\n      let imageLoader: HTMLImageElement | null = 'Image' in window ? new Image() : (document.createElement('img') as HTMLImageElement);\n      imageLoader.onload = (): void => { imageLoader = null; };\n      imageLoader.src = url;\n      cb();\n      return;\n    }\n\n    fetch(url, DEFAULTS.fetchConf).then(cb).catch((err) => {\n      this.warn(WARN.fetchError, err);\n      cb();\n    });\n  }\n\n  private initAutoTracking(): void {\n    const autoTrack = (): void => {\n      this.track();\n    };\n\n    if (this.trackHash) {\n      this.on(window, EventName.HashChange, autoTrack);\n    }\n\n    this.on(window, EventName.PopState, autoTrack);\n\n    this.autoTimer = setInterval((): void => {\n      if (!this.sending && this.current !== this.getCurrentUrl()) {\n        autoTrack();\n      }\n    }, DEFAULTS.pollMs);\n\n    autoTrack();\n  }\n\n  private initGlobalErrors(): void {\n    const prev = window.onerror as OnErrorEventHandlerNonNull | null;\n    window.onerror = ((msg: Event|string, url: string, line: number, column: number, error: Error): void => {\n      const m = String(msg || DEFAULTS.globalError.msg);\n      const u = String(url || DEFAULTS.globalError.url);\n      const ln = String(line || DEFAULTS.globalError.line);\n      const col = String(column || DEFAULTS.globalError.column);\n\n      if (u.includes(this.loc.origin)) {\n        this.pushEvent(EventName.GlobalError, `Error: ${m}. File: ${u.replace(this.loc.origin, '')} at ${this.loc.href}:${ln}:${col}`);\n      }\n\n      if (typeof prev === 'function') {\n        prev.call(window, msg, url, line, column, error);\n      }\n    }) as OnErrorEventHandlerNonNull;\n\n    this.on(window, EventName.UnhandledRejection, (evt: Event): void => {\n      const e = evt as PromiseRejectionEvent;\n      const v = (e && typeof e.reason === 'object' && e.reason && 'message' in e.reason) ? String(e.reason.message) : String(e?.reason ?? 'Undefined Rejection Reason');\n      this.pushEvent(EventName.GlobalError, `Unhandled Rejection: ${v}. At: ${this.loc.href}`);\n    });\n  }\n\n  private isIgnored(pathname: string): boolean {\n    if (!this.ignoredPaths.size) {\n      return false;\n    }\n\n    const paths = Array.from(this.ignoredPaths);\n    for (let i = paths.length - 1; i >= 0; i--) {\n      const rule = paths[i];\n      if (typeof rule === 'string') {\n        if (rule.endsWith('*')) {\n          const prefix = rule.slice(0, -1);\n          if (pathname.startsWith(prefix)) {\n            return true;\n          }\n        } else {\n          if (pathname === rule) {\n            return true;\n          }\n        }\n      } else if (rule instanceof RegExp) {\n        if (rule.test(pathname)) {\n          return true;\n        }\n      }\n    }\n    return false;\n  }\n\n  private getCurrentUrl() {\n    const url = new URL(this.loc.href);\n    if (!this.trackHash) {\n      url.hash = '';\n    }\n\n    if (!this.trackQuery) {\n      url.search = '';\n    } else if (this.ignoredQueries.size) {\n      Array.from(url.searchParams.keys()).forEach((key: string) => {\n        if (this.ignoredQueries.has(key.toLowerCase())) {\n          url.searchParams.delete(key);\n        }\n      });\n    }\n\n    return url.href;\n  }\n\n  public destroy(): void {\n    for (let i = this.eventRemovers.length - 1; i >= 0; i--) {\n      this.eventRemovers[i]?.();\n    }\n    this.eventRemovers.length = 0;\n    if (this.autoTimer) {\n      clearInterval(this.autoTimer);\n      this.autoTimer = null;\n    }\n  }\n}\n\nexport default OstrioWebAnalytics;\n"],"names":["Transport"],"mappings":"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"}